name: test-and-publish

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - 3.11
          - 3.12
          - 3.13

    steps:
    - uses: actions/checkout@v3
    - name: 'Set up Python ${{ matrix.python-version }}'
      uses: 'actions/setup-python@v4'
      with:
        python-version: '${{ matrix.python-version }}'
        cache: 'pip'
        cache-dependency-path: 'pyproject.toml'
    - name: Install dependencies
      run: pip install -e '.[test]' poethepoet
    - run: poe lint
    - name: Test with pytest
      run: pytest --cov=arger --cov-report=html --cov-report=term-missing:skip-covered
    - id: Coverage
      if: matrix.python-version == 3.12
      run: echo "##[set-output name=data;]$(python tasks.py show_coverage)"
    - name: coverage badge
      uses: RubbaBoy/BYOB@v1.3.0
      if: matrix.python-version == 3.12
      with:
        NAME: coverage
        LABEL: 'Coverage'
        STATUS: ${{ steps.Coverage.outputs.data }}
        COLOR: 42a7f5
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check_tag:
    name: Check Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.check_tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - id: check_tag
        run: |
          git fetch --tags
          git tag --points-at HEAD
          tag=$(git tag --points-at HEAD | head -n 1)
          echo "tag=$tag" >> $GITHUB_OUTPUT

  release:
    name: Create Release
    needs: [test, check_tag]
    runs-on: ubuntu-latest
    if: needs.check_tag.outputs.tag != '' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      attestations: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'
      - name: Build
        run: |
          pip install build
          pip install '.[doc]'
          python -m build .
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
      - name: Deploy docs
        run: mkdocs gh-deploy --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
